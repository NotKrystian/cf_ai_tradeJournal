<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trade Journal Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #050816;
      color: #f9fafb;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 1000px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.8);
    }
    .header {
      padding: 8px 4px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .title-block {
      min-width: 0;
    }
    .title {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    .subtitle span {
      color: #38bdf8;
      font-weight: 500;
    }
    .mode-toggle {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .mode-btn {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.82rem;
      cursor: pointer;
      background: transparent;
      color: #9ca3af;
      font-weight: 500;
      transition: background 0.12s ease, color 0.12s ease;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, #22c55e, #06b6d4);
      color: #022c22;
    }

    /* Shared sections */
    .main-section {
      flex: 1;
      display: none;
      flex-direction: column;
      min-height: 0;
    }
    .main-section.active {
      display: flex;
    }

    /* Chat mode */
    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding: 8px 4px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bubble-row {
      display: flex;
    }
    .bubble-row.user {
      justify-content: flex-end;
    }
    .bubble-row.assistant {
      justify-content: flex-start;
    }
    .bubble {
      max-width: 80%;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bubble.user {
      background: #22c55e;
      color: #022c22;
      border-bottom-right-radius: 4px;
    }
    .bubble.assistant {
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-bottom-left-radius: 4px;
    }
    .bubble.meta {
      margin: 0 auto;
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 0.8rem;
      text-align: center;
    }
    .input-area {
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    textarea {
      flex: 1;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: #f9fafb;
      font-family: inherit;
      font-size: 0.9rem;
      outline: none;
    }
    textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }
    button.primary {
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #06b6d4);
      color: #022c22;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s;
      white-space: nowrap;
    }
    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.35);
    }
    button.primary:disabled {
      opacity: 0.6;
      transform: none;
      box-shadow: none;
      cursor: default;
    }
    .hint {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .hint code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    /* Log trade mode */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 12px;
      margin-bottom: 10px;
      margin-top: 6px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }
    .field label {
      color: #e5e7eb;
    }
    .field small {
      color: #9ca3af;
      font-size: 0.75rem;
    }
    .field input,
    .field select,
    .field textarea {
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      font-family: inherit;
      font-size: 0.85rem;
      padding: 7px 8px;
      outline: none;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }
    .field textarea {
      min-height: 60px;
      resize: vertical;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 4px;
    }
    .log-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      padding-top: 8px;
    }
    .status {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .status.success {
      color: #4ade80;
    }
    .status.error {
      color: #f97373;
    }

    /* Trades table mode */
    .trades-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .trades-header-title {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .trades-header-sub {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .trades-refresh {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }
    .trades-refresh button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.8rem;
      padding: 6px 10px;
      cursor: pointer;
    }
    .trades-refresh button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .trades-table-wrapper {
      flex: 1;
      overflow: auto;
      margin-top: 4px;
    }
    table.trades-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 600px;
    }
    table.trades-table thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      z-index: 1;
    }
    table.trades-table th,
    table.trades-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.5);
      text-align: left;
      vertical-align: top;
    }
    table.trades-table th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.78rem;
    }
    table.trades-table tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.6);
    }
    .trade-reason {
      max-width: 260px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .badge.win {
      border-color: #4ade80;
      color: #4ade80;
    }
    .badge.loss {
      border-color: #f97373;
      color: #f97373;
    }
    .badge.breakeven {
      border-color: #e5e7eb;
      color: #e5e7eb;
    }
    .trades-empty {
      font-size: 0.82rem;
      color: #9ca3af;
      padding: 12px 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="title-block">
        <div class="title">Trade Journal Coach</div>
        <div class="subtitle">
          Backend: <span>app.k-kasperski.workers.dev</span> — log, review & analyze your trades.
        </div>
      </div>
      <div class="mode-toggle">
        <button type="button" class="mode-btn active" data-mode="coach">Coach</button>
        <button type="button" class="mode-btn" data-mode="log">Log Trade</button>
        <button type="button" class="mode-btn" data-mode="trades">Trades</button>
      </div>
    </header>

    <!-- COACH MODE -->
    <main id="coach-mode" class="main-section active">
      <section id="chat-log" class="chat-log"></section>

      <form id="chat-form" class="input-area">
        <div class="input-row">
          <textarea
            id="user-input"
            placeholder="Ask things like: “What patterns do you see in my last 20 trades?” or “What should I change this week?”"
          ></textarea>
          <button type="submit" id="send-btn" class="primary">Send</button>
        </div>
        <div class="hint">
          Uses your stored trades from D1. Logging happens via <code>Log Trade</code> mode or direct
          <code>POST /trades</code>.
        </div>
      </form>
    </main>

    <!-- LOG TRADE MODE -->
    <main id="log-mode" class="main-section">
      <form id="log-form">
        <div class="section-title">Log a new trade</div>
        <div class="form-grid">
          <div class="field">
            <label for="entered-at">Time entered *</label>
            <input type="datetime-local" id="entered-at" required />
            <small>When you opened the trade</small>
          </div>

          <div class="field">
            <label for="exited-at">Time exited</label>
            <input type="datetime-local" id="exited-at" />
            <small>Leave blank if trade is still open</small>
          </div>

          <div class="field">
            <label for="outcome">Outcome</label>
            <select id="outcome">
              <option value="">Select outcome (optional)</option>
              <option value="win">Win</option>
              <option value="loss">Loss</option>
              <option value="breakeven">Breakeven</option>
            </select>
            <small>Used for pattern analysis</small>
          </div>

          <div class="field">
            <label for="percent-risked">% Risked</label>
            <input type="number" step="0.01" id="percent-risked" placeholder="e.g. 1" />
            <small>Percent of account at risk (optional)</small>
          </div>

          <div class="field">
            <label for="percent-return">% Return</label>
            <input type="number" step="0.01" id="percent-return" placeholder="e.g. 2.5" />
            <small>Percent gain/loss on the trade (optional)</small>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label for="reason-open">Reasoning at open *</label>
            <textarea id="reason-open" required placeholder="Setup, confluence, risk, why you took it..."></textarea>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label for="reason-close">Reasoning at close</label>
            <textarea id="reason-close" placeholder="Why you exited: rules, emotions, signal, etc."></textarea>
          </div>
        </div>

        <div class="log-footer">
          <div id="log-status" class="status">Fields marked * are required.</div>
          <button type="submit" id="log-submit-btn" class="primary">Save trade</button>
        </div>
      </form>
    </main>

    <!-- TRADES MODE -->
    <main id="trades-mode" class="main-section">
      <div class="trades-header">
        <div>
          <div class="trades-header-title">Your trades</div>
          <div id="trades-summary" class="trades-header-sub">
            Loading…
          </div>
        </div>
        <div class="trades-refresh">
          <button id="trades-refresh-btn" type="button">Refresh</button>
        </div>
      </div>
      <div class="trades-table-wrapper">
        <div id="trades-empty" class="trades-empty" style="display:none;">
          No trades yet. Log a few trades, then come back here.
        </div>
        <table class="trades-table" id="trades-table" style="display:none;">
          <thead>
            <tr>
              <th>Entered</th>
              <th>Exited</th>
              <th>Outcome</th>
              <th>% Risked</th>
              <th>% Return</th>
              <th>Reason (open)</th>
              <th>Reason (close)</th>
            </tr>
          </thead>
          <tbody id="trades-tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = "https://app.k-kasperski.workers.dev";

    // ===== Mode switching =====
    const modeButtons = document.querySelectorAll(".mode-btn");
    const coachSection = document.getElementById("coach-mode");
    const logSection = document.getElementById("log-mode");
    const tradesSection = document.getElementById("trades-mode");

    function setMode(mode) {
      modeButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.mode === mode);
      });

      coachSection.classList.toggle("active", mode === "coach");
      logSection.classList.toggle("active", mode === "log");
      tradesSection.classList.toggle("active", mode === "trades");

      if (mode === "trades") {
        loadTrades();
      }
    }

    modeButtons.forEach((btn) => {
      btn.addEventListener("click", () => setMode(btn.dataset.mode));
    });

    // ===== Coach mode (chat) =====
    const chatLog = document.getElementById("chat-log");
    const chatForm = document.getElementById("chat-form");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    const messages = []; // { role: 'user' | 'assistant', content: string }

    function addMessage(role, content) {
      messages.push({ role, content });

      const row = document.createElement("div");
      row.className = "bubble-row " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble " + role;
      bubble.textContent = content;

      row.appendChild(bubble);
      chatLog.appendChild(row);

      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function addMeta(text) {
      const row = document.createElement("div");
      row.className = "bubble-row meta-row";
      const bubble = document.createElement("div");
      bubble.className = "bubble meta";
      bubble.textContent = text;
      row.appendChild(bubble);
      chatLog.appendChild(row);
      chatLog.scrollTop = chatLog.scrollHeight;
      return row;
    }

    function buildNotesFromMessages() {
      return messages
        .map((m) =>
          (m.role === "user" ? "Trader: " : "Coach: ") + m.content
        )
        .join("\n");
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      addMessage("user", text);
      input.value = "";
      input.focus();

      sendBtn.disabled = true;
      const thinkingRow = addMeta("Analyzing your trades and question…");

      try {
        const notes = buildNotesFromMessages();

        const res = await fetch(`${API_BASE}/analyze`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ notes }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${res.status}`);
        }

        const data = await res.json();
        const answer =
          data.analysis || "No analysis returned from the backend.";
        addMessage("assistant", answer);
      } catch (err) {
        addMessage(
          "assistant",
          "Error talking to backend: " + (err.message || err)
        );
      } finally {
        thinkingRow.remove();
        sendBtn.disabled = false;
      }
    });

    // Initial coach message
    addMessage(
      "assistant",
      "Hey, I’m your trading coach. Your trades are stored in D1 via the /trades API.\n\n" +
      "Use **Log Trade** mode to record new trades, view them in **Trades**, then come back here and ask things like:\n" +
      "• “What are my biggest recurring mistakes?”\n" +
      "• “How should I adjust my risk next week?”\n" +
      "• “Summarize my last 10 trades into 3 key lessons.”"
    );

    // ===== Log Trade mode =====
    const logForm = document.getElementById("log-form");
    const logStatus = document.getElementById("log-status");
    const logSubmitBtn = document.getElementById("log-submit-btn");

    const enteredAtInput = document.getElementById("entered-at");
    const exitedAtInput = document.getElementById("exited-at");
    const outcomeInput = document.getElementById("outcome");
    const percentRiskedInput = document.getElementById("percent-risked");
    const percentReturnInput = document.getElementById("percent-return");
    const reasonOpenInput = document.getElementById("reason-open");
    const reasonCloseInput = document.getElementById("reason-close");

    function toIsoOrNull(value) {
      if (!value) return null;
      const d = new Date(value);
      if (isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    function numberOrNull(value) {
      if (value === "" || value === null || value === undefined) return null;
      const n = Number(value);
      return isNaN(n) ? null : n;
    }

    function setStatus(message, type = "") {
      logStatus.textContent = message;
      logStatus.className = "status" + (type ? " " + type : "");
    }

    logForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const enteredAt = enteredAtInput.value;
      const reasonOpen = reasonOpenInput.value.trim();

      if (!enteredAt || !reasonOpen) {
        setStatus("Please fill in time entered and reasoning at open.", "error");
        return;
      }

      const payload = {
        enteredAt: toIsoOrNull(enteredAt),
        reasonOpen,
        exitedAt: toIsoOrNull(exitedAtInput.value),
        reasonClose: reasonCloseInput.value.trim() || null,
        outcome: outcomeInput.value || null,
        percentRisked: numberOrNull(percentRiskedInput.value),
        percentReturn: numberOrNull(percentReturnInput.value),
      };

      logSubmitBtn.disabled = true;
      setStatus("Saving trade…");

      try {
        const res = await fetch(`${API_BASE}/trades`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${res.status}`);
        }

        setStatus("Trade saved. You can view it in Trades & analyze it in Coach.", "success");

        // Clear non-time fields
        reasonOpenInput.value = "";
        reasonCloseInput.value = "";
        exitedAtInput.value = "";
        outcomeInput.value = "";
        percentRiskedInput.value = "";
        percentReturnInput.value = "";
      } catch (err) {
        console.error(err);
        setStatus("Failed to save trade: " + (err.message || err), "error");
      } finally {
        logSubmitBtn.disabled = false;
      }
    });

    // ===== Trades mode =====
    const tradesSummary = document.getElementById("trades-summary");
    const tradesEmpty = document.getElementById("trades-empty");
    const tradesTable = document.getElementById("trades-table");
    const tradesTbody = document.getElementById("trades-tbody");
    const tradesRefreshBtn = document.getElementById("trades-refresh-btn");

    tradesRefreshBtn.addEventListener("click", () => loadTrades());

    function formatDateShort(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString(undefined, {
        year: "2-digit",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function outcomeToBadge(outcome) {
      if (!outcome) return "";
      const span = document.createElement("span");
      span.className = "badge " + outcome.toLowerCase();
      span.textContent = outcome.toLowerCase();
      return span;
    }

    async function loadTrades() {
      tradesRefreshBtn.disabled = true;
      tradesSummary.textContent = "Loading…";

      try {
        const res = await fetch(`${API_BASE}/trades`);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${res.status}`);
        }

        const data = await res.json();
        const trades = data.trades || [];

        tradesTbody.innerHTML = "";

        if (!trades.length) {
          tradesEmpty.style.display = "block";
          tradesTable.style.display = "none";
          tradesSummary.textContent = "No trades yet.";
          return;
        }

        tradesEmpty.style.display = "none";
        tradesTable.style.display = "table";

        trades.forEach((t) => {
          const tr = document.createElement("tr");

          const tdEntered = document.createElement("td");
          tdEntered.textContent = formatDateShort(t.enteredAt);

          const tdExited = document.createElement("td");
          tdExited.textContent = formatDateShort(t.exitedAt);

          const tdOutcome = document.createElement("td");
          const badge = outcomeToBadge(t.outcome);
          if (badge) tdOutcome.appendChild(badge);

          const tdRisked = document.createElement("td");
          tdRisked.textContent =
            t.percentRisked === null || t.percentRisked === undefined
              ? "-"
              : t.percentRisked.toFixed(2);

          const tdReturn = document.createElement("td");
          tdReturn.textContent =
            t.percentReturn === null || t.percentReturn === undefined
              ? "-"
              : t.percentReturn.toFixed(2);

          const tdReasonOpen = document.createElement("td");
          tdReasonOpen.className = "trade-reason";
          tdReasonOpen.title = t.reasonOpen || "";
          tdReasonOpen.textContent = t.reasonOpen || "";

          const tdReasonClose = document.createElement("td");
          tdReasonClose.className = "trade-reason";
          tdReasonClose.title = t.reasonClose || "";
          tdReasonClose.textContent = t.reasonClose || "";

          tr.appendChild(tdEntered);
          tr.appendChild(tdExited);
          tr.appendChild(tdOutcome);
          tr.appendChild(tdRisked);
          tr.appendChild(tdReturn);
          tr.appendChild(tdReasonOpen);
          tr.appendChild(tdReasonClose);

          tradesTbody.appendChild(tr);
        });

        tradesSummary.textContent = `Showing ${trades.length} trade${trades.length === 1 ? "" : "s"} (latest first)`;
      } catch (err) {
        console.error(err);
        tradesSummary.textContent = "Failed to load trades.";
        tradesEmpty.style.display = "block";
        tradesEmpty.textContent = "Failed to load trades: " + (err.message || err);
        tradesTable.style.display = "none";
      } finally {
        tradesRefreshBtn.disabled = false;
      }
    }
  </script>
</body>
</html>